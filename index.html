<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Random Error Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  </head>
  
<body>

	<div class="modal modal-alert position-static d-block bg-secondary py-5" tabindex="-1" role="dialog" id="modalChoice">
  <div class="modal-dialog modal-fullscreen " role="document">
    <div class="modal-content rounded-3 shadow">
		<div class="modal-header">
			<h2 class="modal-title fs-5"> <span id="errorNumber" class="badge bg-danger">#</span></h2>
      </div>
      <div class="modal-body p-4 text-center">

		<h2 class="mb-0"> <span class="card-header" id="errorTitle" >Page Not Found</span></h2>
        <h4 class="mb-0" id="errorText" >Sorry, the page you are looking for does not exist.</h4>
      </div>
      <div class="modal-footer flex-nowrap p-0">
        <button type="button" id="tryAgainBtn" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 m-0 rounded-0 border-end"><strong>Yes</strong></button>
        <button type="button" id="copyBtn" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 m-0 rounded-0" data-bs-dismiss="modal">No</button>
      </div>
    </div>
  </div>
</div>

	

  <div class="card-footer text-muted">
		  <small class="text-muted">Reference: <span id="errorReference">—</span></small><br>
		  <small class="text-muted">Source: <span id="errorSource">—</span></small>
	  		<small class="text-muted">Selected at <span id="selectedAt">—</span></small>
  </div>

	
	<div>
		<div class="text-end">
			<div class="muted"><small id="errorId">404</small></div>
			<div class="muted"><small id="auto-refresh-note">Auto-refresh in 60s</small></div>
			<div id="fetchErrorAlert" class="alert alert-warning mt-3 d-none" role="alert"></div>
		</div>	
	</div>
  

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

  <script>

    const ERRORS_JSON = 'errors.json';

    // UI elements
    const errorTitle = document.getElementById('errorTitle');
    const errorId = document.getElementById('errorId');
    const errorNumber = document.getElementById('errorNumber');
    const errorText = document.getElementById('errorText');
    const errorReference = document.getElementById('errorReference');
    const errorSource = document.getElementById('errorSource');
    const selectedAt = document.getElementById('selectedAt');
    const autoRefreshNote = document.getElementById('auto-refresh-note');
    const fetchErrorAlert = document.getElementById('fetchErrorAlert');

    const tryAgainBtn = document.getElementById('tryAgainBtn');
    const copyBtn = document.getElementById('copyBtn');

    let errorsArray = [];
    let reloadTimeoutId = null;
    const RELOAD_MS = 60 * 1000; // 1 minute

    // Fetch the JSON file once on load, then pick random objects locally.
    async function loadErrorsFile() {
      try {
        const resp = await fetch(ERRORS_JSON, { cache: "no-store" });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        if (!Array.isArray(data)) throw new Error('JSON is not an array');
        errorsArray = data;
        fetchErrorAlert.classList.add('d-none');
        pickAndShowRandom();
      } catch (err) {
        console.error('Failed to load errors.json:', err);
        fetchErrorAlert.classList.remove('d-none');
        showFetchError(err);
      }
    }

    function showFetchError(err) {
      errorTitle.textContent = 'Failed to load data';
      errorId.textContent = 'ID: —';
      errorNumber.textContent = '#—';
      errorText.textContent = 'Could not fetch errors.json. ' + (err && err.message ? err.message : '');
      errorReference.textContent = '—';
      errorSource.textContent = '—';
      selectedAt.textContent = new Date().toLocaleString();
    }

    function pickAndShowRandom() {
      if (!Array.isArray(errorsArray) || errorsArray.length === 0) {
        errorTitle.textContent = 'No errors available';
        errorText.textContent = 'The errors.json file is empty or malformed.';
        return;
      }
      const idx = Math.floor(Math.random() * errorsArray.length);
      const obj = errorsArray[idx];

      // Support both capitalized keys and camelCase by falling back
      const Id = obj.Id ?? obj.id ?? obj.ID ?? null;
      const errorNum = obj['error number'] ?? obj.errorNumber ?? obj.error_number ?? obj.errorNum ?? '—';
      const text = obj['error text'] ?? obj.errorText ?? obj.text ?? obj.message ?? 'No error text';
      const reference = obj.reference ?? obj.Reference ?? '—';
      const source = obj.source ?? obj.Source ?? '—';

      errorTitle.textContent = errorNum//.substring(4, errorNum.length)//text.length > 80 ? text.slice(0, 80) + '…' : text;
      errorId.textContent = 'ID: ' + (Id ?? '—');
      errorNumber.textContent =  (errorNum.substring(0, 4) ?? '—'); //'#' +
      errorText.textContent = text;
      errorReference.textContent = reference;
      errorSource.textContent = source;
      selectedAt.textContent = new Date().toLocaleString();

      // (Re)start the auto-reload countdown
      startAutoReloadCountdown();
    }

    function startAutoReloadCountdown() {
      // Clear previous timer if any
      if (reloadTimeoutId) clearTimeout(reloadTimeoutId);

      // Display a countdown (optional)
      const end = Date.now() + RELOAD_MS;
      updateCountdownDisplay(Math.ceil((end - Date.now()) / 1000));
      const countdownInterval = setInterval(() => {
        const secsLeft = Math.ceil((end - Date.now()) / 1000);
        if (secsLeft <= 0) {
          clearInterval(countdownInterval);
        }
        updateCountdownDisplay(Math.max(secsLeft, 0));
      }, 700);

      // Final reload after RELOAD_MS
      reloadTimeoutId = setTimeout(() => {
        // Reload the entire page (per requirement)
        location.reload();
      }, RELOAD_MS);
    }

    function updateCountdownDisplay(seconds) {
      autoRefreshNote.textContent = 'Auto-refresh in ' + seconds + 's';
    }

    // Try Again button: pick and show a new random object (without reloading page)
    tryAgainBtn.addEventListener('click', () => {
      pickAndShowRandom();
    });

    // Copy button: copies the displayed error text (and metadata) to clipboard
    copyBtn.addEventListener('click', async () => {
      const payload = [
        errorText.textContent,
        errorId.textContent,
        errorNumber.textContent,
        'Reference: ' + errorReference.textContent,
        'Source: ' + errorSource.textContent,
        'Selected at: ' + selectedAt.textContent
      ].join('\n');
      try {
        await navigator.clipboard.writeText(payload);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => (copyBtn.textContent = 'Copy'), 1500);
      } catch (e) {
        console.warn('Clipboard write failed', e);
        copyBtn.textContent = 'Copy Failed';
        setTimeout(() => (copyBtn.textContent = 'Copy'), 1500);
      }
    });

    // Kick off
    window.addEventListener('load', () => {
      loadErrorsFile();
    });
  </script>
</body>
</html>
